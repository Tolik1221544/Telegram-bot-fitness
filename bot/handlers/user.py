from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, CallbackQueryHandler, ConversationHandler, MessageHandler, filters, \
    CommandHandler
from bot.database import db_manager
from bot.api_client import api_client
from bot.config import config
import logging

logger = logging.getLogger(__name__)

USER_AWAITING_EMAIL = 200
USER_AWAITING_CODE = 201


async def show_balance(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Show user balance"""
    query = update.callback_query
    await query.answer()

    user = query.from_user
    db_user = await db_manager.get_user(user.id)

    if not db_user or not db_user.api_token:
        keyboard = [[InlineKeyboardButton("üîó –°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", callback_data="link_account")]]
        await query.message.edit_text(
            "‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    try:
        balance = await api_client.get_balance(db_user.api_token)

        text = f"""üí∞ *–í–∞—à –±–∞–ª–∞–Ω—Å*

*–ú–æ–Ω–µ—Ç:* `{balance.get('balance', 0)}`
"""

        if balance.get('hasActiveSubscription'):
            expiry = balance.get('subscriptionExpiresAt', '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
            if expiry and len(expiry) >= 10:
                expiry = expiry[:10]
            text += f"\nüìÖ *–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ:* `{expiry}`"
        else:
            text += "\nüìÖ *–ü–æ–¥–ø–∏—Å–∫–∞:* –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞"

        keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]]

        await query.message.edit_text(
            text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='MarkdownV2'
        )

    except Exception as e:
        logger.error(f"Error getting balance: {e}")
        await query.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]])
        )


async def show_stats(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Show user statistics"""
    query = update.callback_query
    await query.answer()

    user = query.from_user
    db_user = await db_manager.get_user(user.id)

    if not db_user or not db_user.api_token:
        keyboard = [[InlineKeyboardButton("üîó –°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", callback_data="link_account")]]
        await query.message.edit_text(
            "‚ùå –°–Ω–∞—á–∞–ª–∞ —Å–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º",
            reply_markup=InlineKeyboardMarkup(keyboard)
        )
        return

    try:
        from datetime import datetime
        stats = await api_client.get_user_stats(db_user.api_token)

        text = f"""üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*

üèãÔ∏è *–¢—Ä–µ–Ω–∏—Ä–æ–≤–æ–∫:* `{stats.get('totalActivities', 0)}`
üçΩ *–ü—Ä–∏–µ–º–æ–≤ –ø–∏—â–∏:* `{stats.get('totalMeals', 0)}`
üí∞ *–ü–æ—Ç—Ä–∞—á–µ–Ω–æ –º–æ–Ω–µ—Ç:* `{db_user.total_spent or 0}`
üìÖ *–° –Ω–∞–º–∏:* `{(datetime.utcnow() - db_user.created_at).days}` –¥–Ω–µ–π
"""

        keyboard = [[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]]

        await query.message.edit_text(
            text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode='MarkdownV2'
        )

    except Exception as e:
        logger.error(f"Error getting stats: {e}")
        await query.message.edit_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
            reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]])
        )


async def start_link_account(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Start account linking process"""
    query = update.callback_query
    await query.answer()

    context.user_data.clear()

    logger.info(f"User {query.from_user.id} starting account linking")

    keyboard = [[InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_linking")]]
    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.message.edit_text(
        "üîó *–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞*\n\n"
        "–í–≤–µ–¥–∏—Ç–µ email, –∫–æ—Ç–æ—Ä—ã–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ Lightweight:",
        reply_markup=reply_markup,
        parse_mode='MarkdownV2'
    )

    return USER_AWAITING_EMAIL


async def handle_email_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle email input"""
    email = update.message.text.strip()

    # Validate email
    import re
    if not re.match(r'^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$', email):
        keyboard = [[InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_linking")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
            reply_markup=reply_markup
        )
        return USER_AWAITING_EMAIL

    try:
        # Send verification code
        success = await api_client.send_verification_code(email)

        if success:
            context.user_data['linking_email'] = email

            keyboard = [[InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_linking")]]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                f"‚úÖ –ö–æ–¥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ {email}\n\n"
                "–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø–∏—Å—å–º–∞:",
                reply_markup=reply_markup
            )
            return USER_AWAITING_CODE
        else:
            keyboard = [[InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_linking")]]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                "‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–æ–¥. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ email:",
                reply_markup=reply_markup
            )
            return USER_AWAITING_EMAIL

    except Exception as e:
        logger.error(f"Error sending verification code: {e}")

        keyboard = [[InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data="start")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=reply_markup
        )

        context.user_data.clear()
        return ConversationHandler.END


async def handle_code_input(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Handle verification code input"""
    code = update.message.text.strip()
    email = context.user_data.get('linking_email')

    if not email:
        keyboard = [[InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data="start")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞. –ù–∞—á–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ: /start",
            reply_markup=reply_markup
        )

        context.user_data.clear()
        return ConversationHandler.END

    try:
        # Confirm email
        result = await api_client.confirm_email(email, code)

        if 'accessToken' in result:
            user = update.effective_user
            db_user = await db_manager.get_user(user.id)

            try:
                link_result = await api_client._request(
                    'POST',
                    '/api/user/link-telegram',
                    headers={'Authorization': f'Bearer {result["accessToken"]}'},
                    json_data={
                        'telegramId': user.id,
                        'username': user.username or ""
                    }
                )

                if link_result.get('success'):
                    logger.info(f"‚úÖ Telegram ID {user.id} successfully linked to backend account")
                else:
                    logger.warning(f"‚ö†Ô∏è Failed to link Telegram ID on backend: {link_result}")

            except Exception as link_error:
                logger.error(f"‚ùå Error linking Telegram ID to backend: {link_error}")
                # –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –¥–∞–∂–µ –µ—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–∏–≤—è–∑–∞—Ç—å - –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ–∑–∂–µ

            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –ë–î –±–æ—Ç–∞
            async with db_manager.SessionLocal() as session:
                db_user.email = email
                db_user.api_token = result['accessToken']
                db_user.api_user_id = result.get('user', {}).get('id')
                session.add(db_user)
                await session.commit()

            keyboard = [[InlineKeyboardButton("üè† –í –º–µ–Ω—é", callback_data="start")]]
            reply_markup = InlineKeyboardMarkup(keyboard)

            try:
                balance = await api_client.get_balance(result['accessToken'])
                balance_text = f"\nüí∞ *–í–∞—à –±–∞–ª–∞–Ω—Å:* `{balance.get('balance', 0)}` –º–æ–Ω–µ—Ç"

                if balance.get('hasActiveSubscription'):
                    expiry = balance.get('subscriptionExpiresAt', '')
                    if expiry and len(expiry) >= 10:
                        balance_text += f"\nüìÖ *–ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ:* `{expiry[:10]}`"
            except:
                balance_text = ""

            success_text = f"""‚úÖ *–ê–∫–∫–∞—É–Ω—Ç —É—Å–ø–µ—à–Ω–æ —Å–≤—è–∑–∞–Ω\\!*{balance_text}

üîó Telegram ID –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É

*–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ:*
‚Ä¢ –ü–æ–∫—É–ø–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Tribute
‚Ä¢ –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –±–∞–ª–∞–Ω—Å –º–æ–Ω–µ—Ç
‚Ä¢ –í–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è"""

            await update.message.reply_text(
                success_text,
                reply_markup=reply_markup,
                parse_mode='MarkdownV2'
            )

            context.user_data.clear()

            logger.info(f"User {user.id} successfully linked account with backend")

            return ConversationHandler.END
        else:
            keyboard = [[InlineKeyboardButton("üîô –û—Ç–º–µ–Ω–∏—Ç—å", callback_data="cancel_linking")]]
            reply_markup = InlineKeyboardMarkup(keyboard)

            await update.message.reply_text(
                "‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:",
                reply_markup=reply_markup
            )
            return USER_AWAITING_CODE

    except Exception as ex:
        logger.error(f"Error confirming code: {ex}")

        keyboard = [[InlineKeyboardButton("üîô –í –º–µ–Ω—é", callback_data="start")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
            reply_markup=reply_markup
        )

        context.user_data.clear()
        return ConversationHandler.END


async def cancel_linking(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Cancel account linking"""
    query = update.callback_query

    logger.info(f"User {update.effective_user.id} cancelled account linking")

    if query:
        await query.answer("‚ùå –û—Ç–º–µ–Ω–µ–Ω–æ")

        keyboard = [[InlineKeyboardButton("üè† –í –º–µ–Ω—é", callback_data="start")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await query.message.edit_text(
            "‚ùå –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            reply_markup=reply_markup
        )
    else:
        keyboard = [[InlineKeyboardButton("üè† –í –º–µ–Ω—é", callback_data="start")]]
        reply_markup = InlineKeyboardMarkup(keyboard)

        await update.message.reply_text(
            "‚ùå –°–≤—è–∑—ã–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.",
            reply_markup=reply_markup
        )

    context.user_data.clear()
    return ConversationHandler.END

async def show_restore(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Show restore purchases"""
    query = update.callback_query
    await query.answer()

    await query.message.edit_text(
        "üîÑ *–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∫—É–ø–æ–∫*\n\n"
        "–≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ –ø–æ–∫—É–ø–∫–∏ "
        "–º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏\\.\n\n"
        "_–í—Å–µ –≤–∞—à–∏ –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –º–æ–Ω–µ—Ç—ã –±—É–¥—É—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã\\._",
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]]),
        parse_mode='MarkdownV2'
    )


async def show_help(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Show help"""
    query = update.callback_query
    await query.answer()

    help_text = """‚ÑπÔ∏è *–ü–æ–º–æ—â—å*

*–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*
/start \\- –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
/help \\- –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞
/balance \\- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å
/admin \\- –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å \\(–¥–ª—è –∞–¥–º–∏–Ω–æ–≤\\)

*–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:*
1Ô∏è‚É£ –°–≤—è–∂–∏—Ç–µ –∞–∫–∫–∞—É–Ω—Ç —Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º
2Ô∏è‚É£ –ö—É–ø–∏—Ç–µ –º–æ–Ω–µ—Ç—ã –∏–ª–∏ –ø–æ–¥–ø–∏—Å–∫—É
3Ô∏è‚É£ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–æ–Ω–µ—Ç—ã –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏

*–ü–æ–¥–¥–µ—Ä–∂–∫–∞:*
–ï—Å–ª–∏ —É –≤–∞—Å –ø—Ä–æ–±–ª–µ–º—ã, –Ω–∞–ø–∏—à–∏—Ç–µ @support
"""

    await query.message.edit_text(
        help_text,
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("üîô –ù–∞–∑–∞–¥", callback_data="start")]]),
        parse_mode='MarkdownV2'
    )


async def back_to_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """Return to main menu"""
    query = update.callback_query
    await query.answer()

    context.user_data.clear()

    user = query.from_user
    db_user = await db_manager.get_user(user.id)

    welcome_text = f"üëã *–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user.first_name}\\!*\n\n"

    if db_user and db_user.api_token:
        try:
            balance = await api_client.get_balance(db_user.api_token)
            welcome_text += f"üí∞ *–í–∞—à –±–∞–ª–∞–Ω—Å:* `{balance.get('balance', 0)}` –º–æ–Ω–µ—Ç\n"

            if balance.get('hasActiveSubscription'):
                expiry = balance.get('subscriptionExpiresAt', '')
                if expiry and len(expiry) >= 10:
                    expiry = expiry[:10]
                    welcome_text += f"üìÖ *–ü–æ–¥–ø–∏—Å–∫–∞ –¥–æ:* `{expiry}`\n"
        except Exception as e:
            logger.error(f"Error getting balance: {e}")
            welcome_text += "üí∞ *–í–∞—à –±–∞–ª–∞–Ω—Å:* –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è\\.\\.\\.\n"
    else:
        welcome_text += "üí∞ *–í–∞—à –±–∞–ª–∞–Ω—Å:* –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è\\.\\.\\.\n"

    # Main menu keyboard
    keyboard = [
        [InlineKeyboardButton("üí∞ –ë–∞–ª–∞–Ω—Å", callback_data="balance"),
         InlineKeyboardButton("üí≥ –ü–æ–¥–ø–∏—Å–∫–∏", callback_data="subscriptions")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="stats"),
         InlineKeyboardButton("üîÑ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å", callback_data="restore")],
        [InlineKeyboardButton("üîó –°–≤—è–∑–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", callback_data="link_account")],
        [InlineKeyboardButton("‚ÑπÔ∏è –ü–æ–º–æ—â—å", callback_data="help")]
    ]

    if user.id in config.ADMIN_IDS:
        keyboard.append([InlineKeyboardButton("‚öôÔ∏è –ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å", callback_data="admin")])

    reply_markup = InlineKeyboardMarkup(keyboard)

    await query.message.edit_text(welcome_text, reply_markup=reply_markup, parse_mode='MarkdownV2')


def register_user_handlers(application):
    """Register user handlers"""
    application.add_handler(CallbackQueryHandler(back_to_start, pattern="^start$"))

    application.add_handler(CallbackQueryHandler(show_balance, pattern="^balance$"))
    application.add_handler(CallbackQueryHandler(show_stats, pattern="^stats$"))
    application.add_handler(CallbackQueryHandler(show_restore, pattern="^restore$"))
    application.add_handler(CallbackQueryHandler(show_help, pattern="^help$"))

    link_conv = ConversationHandler(
        entry_points=[
            CallbackQueryHandler(start_link_account, pattern="^link_account$")
        ],
        states={
            USER_AWAITING_EMAIL: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_email_input),
                CallbackQueryHandler(cancel_linking, pattern="^cancel_linking$")
            ],
            USER_AWAITING_CODE: [
                MessageHandler(filters.TEXT & ~filters.COMMAND, handle_code_input),
                CallbackQueryHandler(cancel_linking, pattern="^cancel_linking$")
            ],
        },
        fallbacks=[
            CommandHandler("cancel", cancel_linking),
            CommandHandler("start", cancel_linking),
            CallbackQueryHandler(cancel_linking, pattern="^cancel_linking$"),
            CallbackQueryHandler(back_to_start, pattern="^start$")
        ],

        per_user=True,
        per_chat=True,
        per_message=False,
        allow_reentry=True
    )

    application.add_handler(link_conv)